/**
 * CONSTRUO 2026 - Main JavaScript (Supabase)
 * Supabase data loading functions for public website
 */

import supabase from './supabase-config.js';

class ConstruoSupabaseData {
    constructor() {
        this.cache = {};
    }

    async loadAll() {
        try {
            console.log('Loading website data from Supabase...');

            const [siteConfig, events, timeline, speakers, sponsors, organizers] = await Promise.all([
                this.getSiteConfig(),
                this.getEvents(),
                this.getTimeline(),
                this.getSpeakers(),
                this.getSponsors(),
                this.getOrganizers()
            ]);

            return {
                siteConfig,
                events,
                timeline,
                speakers,
                sponsors,
                organizers
            };
        } catch (error) {
            console.error('Error loading data from Supabase:', error);
            throw error;
        }
    }

    async getSiteConfig() {
        try {
            const { data, error } = await supabase
                .from('site_config')
                .select('*')
                .eq('config_key', 'main')
                .single();

            if (error) throw error;
            this.cache.siteConfig = data;
            return data;
        } catch (error) {
            console.error('Error fetching site config:', error);
            return null;
        }
    }

    async getEvents() {
        try {
            const { data, error } = await supabase
                .from('events')
                .select('*')
                .eq('status', 'active')
                .order('created_at', { ascending: false });

            if (error) throw error;
            this.cache.events = data;
            return data;
        } catch (error) {
            console.error('Error fetching events:', error);
            return [];
        }
    }

    async getTimeline() {
        try {
            const { data, error } = await supabase
                .from('timeline_days')
                .select('*')
                .order('order', { ascending: true });

            if (error) throw error;
            this.cache.timeline = data;
            return data;
        } catch (error) {
            console.error('Error fetching timeline:', error);
            return [];
        }
    }

    async getSpeakers() {
        try {
            const { data, error } = await supabase
                .from('speakers')
                .select('*')
                .eq('status', 'active')
                .order('order', { ascending: true });

            if (error) throw error;
            this.cache.speakers = data;
            return data;
        } catch (error) {
            console.error('Error fetching speakers:', error);
            return [];
        }
    }

    async getSponsors() {
        try {
            const { data, error } = await supabase
                .from('sponsors')
                .select('*')
                .eq('status', 'active')
                .order('order', { ascending: true });

            if (error) throw error;
            this.cache.sponsors = data;
            return data;
        } catch (error) {
            console.error('Error fetching sponsors:', error);
            return [];
        }
    }

    async getOrganizers() {
        try {
            const { data, error } = await supabase
                .from('organizers')
                .select('*')
                .eq('status', 'active')
                .order('order', { ascending: true });

            if (error) throw error;
            this.cache.organizers = data;
            return data;
        } catch (error) {
            console.error('Error fetching organizers:', error);
            return [];
        }
    }

    async getActiveForm() {
        try {
            const { data, error } = await supabase
                .from('registration_forms')
                .select('*')
                .eq('is_active', true)
                .order('updated_at', { ascending: false })
                .limit(1)
                .single();

            if (error) {
                if (error.code === 'PGRST116') return null; // No active form found
                throw error;
            }
            return {
                ...data,
                isActive: data.is_active,
                updatedAt: data.updated_at
            };
        } catch (error) {
            console.error('Error fetching active form:', error);
            return null;
        }
    }

    async createRegistration(regData) {
        try {
            const registrationId = `reg_${Date.now()}_${Math.random().toString(36).substring(7)}`;

            const { data, error } = await supabase
                .from('registrations')
                .insert({
                    registration_id: registrationId,
                    registration_number: '', // Will be auto-generated by trigger
                    form_id: regData.formId || null,
                    participant: regData.participant || {},
                    data: regData.data || {},
                    events: regData.events || [],
                    team_members: regData.teamMembers || [],
                    payment: regData.payment || { amount: 0, status: 'pending' },
                    status: 'pending'
                })
                .select()
                .single();

            if (error) throw error;
            return data;
        } catch (error) {
            console.error('Error creating registration:', error);
            throw error;
        }
    }
}

window.ConstruoSupabaseData = new ConstruoSupabaseData();
console.log('ConstruoSupabaseData initialized with methods:', Object.getOwnPropertyNames(ConstruoSupabaseData.prototype));
export default ConstruoSupabaseData;
